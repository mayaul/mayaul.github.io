---
layout: post
title: "feign 좀더 나아가기"
excerpt: "이전 feign 게시글에서 좀더 상세하게 "
date: 2019-12-12 00:00:00 +0900
comments: true
published : false
tag:
- feign
---
### 소개
<hr/>

* 이 글은 이전에 작성된 게시글에서 추가 보완사항에 대해서 작성되었습니다.[feign](https://mayaul.github.io/feign)   

### http client
* feign 에서 지원하는 http client 는 ApacheHttpClient 와 OkHttpClient 가 있다.  default 는 ApacheHttpClient 다.
    - HttpClientFeignLoadBalancedConfiguration 와 OkHttpFeignLoadBalancedConfiguration 을 볼면 알 수있는데, `@ConditionalOnProperty(value = "feign.httpclient.enabled", matchIfMissing = true)` 로 설정되어 있다.
    - 아래 내용을 의존성에 넣어보면 확인 할 수 있다.
        ~~~ gradle
        compile group: 'io.github.openfeign', name: 'feign-httpclient', version: '9.5.1' 넣어보면, 디버깅으로 확인 할 수 있다.
        ~~~
* OkHttpClient 의 장점에 대해서는 링크를 통해서 확인 할 수있다.[OkHttpClient 가 ApacheHttpClient 비해 장단점](https://github.com/square/okhttp/issues/3472)
    ~~~
    OkHttp has HTTP/2, a built-in response cache, web sockets, and a simpler API. 
    It’s got better defaults and is easier to use efficiently. 
    It’s got a better URL model, a better cookie model, a better headers model and a better call model. OkHttp makes canceling calls easy. 
    OkHttp has carefully managed TLS defaults that are secure and widely compatible. 
    Okhttp works with Retrofit, which is a brilliant API for REST. 
    It also works with Okio, which is a great library for data streams. 
    OkHttp is a small library with one small dependency (Okio) and is less code to learn. 
    OkHttp is more widely deployed, with a billion Android 4.4+ devices using it internally.
    ~~~

### logging
* feign 의 logging 설정의 경우, `DEBUG` level 에서만 작동을 한다. [feign logging](https://cloud.spring.io/spring-cloud-netflix/multi/multi_spring-cloud-feign.html#_feign_logging)

### error response 처리
* feign 의 경우 `200 <= response status < 300` 일때만 정상이라고 판단하고 (`decode404` 가 true 이면, 404 포함), 그 이외의 http status 값은 errorDecoder 가 수행이 된다.
* 그때는, method 의 return type 을 feign 의 Response 로 지정한다음에 errorDecoder 를 수행여부를 직접 코드로 구현하는 방법이 있다.

~~~ java
@FeignClient(name = "example-talk", url = "http://localhost:8080")
public interface ExampleClient {

    @RequestLine("GET /{status}")
    Response json(@Param("status") int status);
}
~~~
~~~ java
public class Example {
    
    public void test() {
        Response response = specialClient.json(500);

        if (HttpStatus.Series.valueOf(response.status) == HttpStatus.Series.SERVER_ERROR) {
            throw new IllegalStateException("server error 발생");
        }
        
        // 추가적으로 필요한 로직 수행
    }
}
~~~

### feign configuration class 에서 `@Configuration` 넣어보기
* configuration class 에 `@Configuration` 을 하지 않으면 Bean 이 Singleton 이 되지 않는다.
* feign 의 configuration class 의 경우 이전 게시글에서 @Configuration 을 넣지 않는것을 추천하였는데, feign guide 문서에는 이와 반대로 하고 있다.[참고링크](https://cloud.spring.io/spring-cloud-netflix/multi/multi_spring-cloud-feign.html#spring-cloud-feign-overriding-defaults)
    ~~~
    FooConfiguration does not need to be annotated with @Configuration. 
    However, if it is, then take care to exclude it from any @ComponentScan that would otherwise include this configuration as it will become the default source for feign.Decoder, feign.Encoder, feign.Contract, etc., when specified. 
    This can be avoided by putting it in a separate, non-overlapping package from any @ComponentScan or @SpringBootApplication, or it can be explicitly excluded in @ComponentScan.
    ~~~

### feign client 용 interface 만 정의하고 실제 구현체는 달리 사용하기

### @PathVariable, @RequestParam 에 Collection 이 들어갈때 key=value1&key=value2 가 아니라 key=value1,value2 하기  
